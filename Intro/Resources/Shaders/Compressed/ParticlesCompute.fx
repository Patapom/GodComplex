#include"Inc/Global.fx"
Texture2D _TexParticlesPositions0:register(t10),_TexParticlesPositions1:register(t11),_TexParticlesNormals:register(t12),_TexParticlesTangents:register(t13);cbuffer cbRender:register( b10){float3 _dUV;float2 _DeltaTime;};struct VS_IN{float4 __Position:SV_POSITION;};struct PS_OUT{float4 Position:SV_TARGET0;float4 Normal:SV_TARGET1;float4 Tangent:SV_TARGET2;};VS_IN VS(VS_IN z){return z;}PS_OUT PS(VS_IN e){float2 p=e.__Position.xy*_dUV.xy;float4 f=_TexParticlesPositions1.SampleLevel(PointClamp,p,0.);float z=f.w+_Time.y;float4 n=_TexParticlesPositions0.SampleLevel(PointClamp,p,0.);float3 P=f.xyz,w=n.xyz;w=P-(P-w)*_DeltaTime.y;float y=saturate(10000.*z);float4 s=_TexParticlesNormals.SampleLevel(PointClamp,p,0.);float3 t=s.xyz;float V=s.w;float4 L=_TexParticlesTangents.SampleLevel(PointClamp,p,0.);float3 R=L.xyz,r=0.,x=0.;if(L.w>0.){r+=float3(0,.0005,0);float3 c=P;c+=400.*_Time.x;r+=.01*_TexNoise3D.SampleLevel(LinearWrap,c,0.).xyz;}else{r-=float3(0,.0005,0);float3 c=10.*P;c+=400.*_Time.x;r+=.025*_TexNoise3D.SampleLevel(LinearWrap,c,0.).xyz;}x*=y;r*=y;float3 c=2.*P-w+_DeltaTime.x*(x+_DeltaTime.x*r),l=.5*P;float4 D=_TexNoise3D.SampleLevel(LinearWrap,l,0.);D.xyz=normalize(D.xyz);D.w*=_DeltaTime.x;D.w*=y;float3 T=normalize(RotateVector(t,D.xyz,D.w)),a=normalize(RotateVector(R,D.xyz,D.w));float i=-.2*_Time.y;i*=y;V=max(0.,V+i);PS_OUT N;N.Position=float4(c,z);N.Normal=float4(T,V);N.Tangent=float4(a,L.w);return N;}